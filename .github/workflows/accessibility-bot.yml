name: Accessibility Report Bot

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  accessibility-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with JSON output
        run: |
          npx eslint . --format json --output-file eslint-report.json || true
          npx eslint . --format json --output-file eslint-a11y-report.json -c eslint-a11y-only.config.js || true

      - name: Generate Accessibility Report
        id: generate-report
        run: |
          node .github/scripts/generate-a11y-report.js

      - name: Create/Update PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportData = JSON.parse(fs.readFileSync('accessibility-report.json', 'utf8'));
            
            const { owner, repo, number: issue_number } = context.issue;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ” Accessibility Report')
            );
            
            const commentBody = `## ğŸ” Accessibility Report
            
            ### ğŸ“Š Overall Score: ${reportData.overallScore}/100
            
            ${reportData.overallScore >= 90 ? 'ğŸŸ¢' : reportData.overallScore >= 70 ? 'ğŸŸ¡' : 'ğŸ”´'} **${reportData.gradeLabel}**
            
            ### ğŸ“ˆ Summary
            - **Total Issues**: ${reportData.totalIssues}
            - **Critical**: ${reportData.critical} ğŸ”´
            - **Major**: ${reportData.major} ğŸŸ   
            - **Minor**: ${reportData.minor} ğŸŸ¡
            - **Files Affected**: ${reportData.filesAffected}
            
            ### ğŸ¯ WCAG 2.1 Compliance
            - **Level A**: ${reportData.wcagA}% âœ…
            - **Level AA**: ${reportData.wcagAA}% ${reportData.wcagAA >= 90 ? 'âœ…' : 'âš ï¸'}
            
            ### ğŸ” Issue Breakdown
            ${reportData.issueBreakdown}
            
            ### ğŸ“š Top Recommendations
            ${reportData.recommendations}
            
            ### ğŸ› ï¸ Quick Fixes
            \`\`\`bash
            # Auto-fix what can be fixed
            npm run lint:fix
            
            # Run accessibility tests
            npm run test:a11y
            \`\`\`
            
            <details>
            <summary>ğŸ“‹ Detailed Issues (Click to expand)</summary>
            
            ${reportData.detailedIssues}
            
            </details>
            
            ---
            *ğŸ¤– Generated by Accessibility Bot â€¢ [Learn more about accessibility](https://github.com/${owner}/${repo}/blob/main/DEVELOPER_DEPLOYMENT_GUIDE.md)*`;
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: commentBody
              });
            }

      - name: Set PR Status Check
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportData = JSON.parse(fs.readFileSync('accessibility-report.json', 'utf8'));
            
            const { owner, repo } = context.repo;
            const sha = context.payload.pull_request.head.sha;
            
            const state = reportData.overallScore >= 80 ? 'success' : 
                         reportData.overallScore >= 60 ? 'pending' : 'failure';
            
            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state,
              target_url: `https://github.com/${owner}/${repo}/pull/${context.issue.number}`,
              description: `Accessibility Score: ${reportData.overallScore}/100`,
              context: 'accessibility/score'
            });

      - name: Upload Reports as Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-reports
          path: |
            eslint-report.json
            eslint-a11y-report.json
            accessibility-report.json